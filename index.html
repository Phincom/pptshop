<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT Bar - Digital Kiosk System</title>
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.5;
            background: #f7fafc;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        .login-box h2 {
            margin-top: 0;
            color: #2d3748;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }

        /* Navigation */
        .tabs {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #4a5568;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }

        /* Views */
        .view {
            display: none;
            padding: 2rem;
        }

        .view.active {
            display: block;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .submit-btn {
            background: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        .submit-btn:hover {
            background: #3182ce;
        }

        /* Chef view */
        #chef {
            display: none;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .orders-list {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .order-card {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        /* Display view */
        #display {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 60px);
        }

        .order-display {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Chef Login Overlay -->
    <div id="chefLogin" class="login-overlay" style="display: none;">
        <div class="login-box">
            <h2>Chef Login</h2>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="chefPassword" placeholder="Enter chef password">
            </div>
            <button onclick="loginChef()" class="submit-btn">Login</button>
            <p id="loginError" style="color: #e53e3e; margin-top: 8px;"></p>
        </div>
    </div>

    <nav class="tabs" id="modeSelector">
        <button class="tab-btn active" data-view="kiosk">Order</button>
        <button class="tab-btn" data-view="chef">Chef</button>
        <button class="tab-btn" data-view="display">Display</button>
    </nav>

    <!-- Kiosk View -->
    <div id="kiosk" class="view active">
        <form id="orderForm" onsubmit="submitOrder(event)">
            <h2>Place Your Order</h2>
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label for="topic">PPT Topic</label>
                <input type="text" id="topic" required>
            </div>
            <div class="form-group">
                <label for="slides">Number of Slides</label>
                <select id="slides" required>
                    <option value="5">5 Slides</option>
                    <option value="10">10 Slides</option>
                    <option value="15">15 Slides</option>
                    <option value="20">20 Slides</option>
                </select>
            </div>
            <div class="form-group">
                <label for="style">Style Preference</label>
                <select id="style" required>
                    <option value="professional">Professional</option>
                    <option value="creative">Creative</option>
                    <option value="minimal">Minimal</option>
                    <option value="modern">Modern</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="deliveryMethod">Delivery Method</label>
                <select id="deliveryMethod" required>
                    <option value="email">Email</option>
                    <option value="website">Download from Website</option>
                </select>
            </div>
            <div class="form-group" id="emailGroup">
                <label for="customerEmail">Your Email</label>
                <input type="email" id="customerEmail" required placeholder="alibingulshadahammed@gmail.com">
            </div>
            <button type="submit" class="submit-btn">Place Order</button>
            <div id="orderTracker" style="margin-top: 20px; display: none;">
                <h3>Track Your Order</h3>
                <p>Your Order ID: <span id="trackingId"></span></p>
                <p>Status: <span id="orderStatus">Pending</span></p>
                <p>Estimated completion: <span id="estimatedTime"></span></p>
            </div>
        </form>
    </div>

    <!-- Chef View -->
    <div id="chef" class="view">
        <div class="orders-list">
            <h2>Pending Orders</h2>
            <div id="pendingOrders"></div>
        </div>
        <div class="orders-list">
            <h2>Completed Orders</h2>
            <div id="completedOrders"></div>
        </div>
    </div>

    <!-- Display View -->
    <div id="display" class="view">
        <div class="order-display">
            <h2>Now Serving</h2>
            <div id="currentOrder">
                <h3>No orders ready for pickup</h3>
            </div>
        </div>
    </div>

    <script>
        // Secure authentication
        let isChefAuthenticated = false;
        let loginAttempts = 0;
        let lastAttemptTime = 0;
        
        // Constants
        const MAX_ATTEMPTS = 3;
        const LOCKOUT_TIME = 30 * 60 * 1000; // 30 minutes

        // Secure key verification - split and encrypted
        async function verifyAccess(input) {
            try {
                const key = await window.crypto.subtle.digest(
                    'SHA-256',
                    new TextEncoder().encode(input + navigator.userAgent)
                );
                return Array.from(new Uint8Array(key))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            } catch {
                return false;
            }
        }

      
        if (!localStorage.getItem('chefPasswordHash')) {
            localStorage.setItem('chefPasswordHash', '7e6cdb346634375892e4c1a5799c86f775b93f5f9a3aa4142173d0100eb718c9');
            localStorage.setItem('passwordLastChanged', Date.now());
        }

        
        async function enhancedHash(text) {
            try {
                // Salt generation (browser-specific)
                const salt = window.navigator.userAgent + window.navigator.language;
                
                // Initial hash with salt
                const encoder = new TextEncoder();
                const data = encoder.encode(text + salt);
                let hash = await crypto.subtle.digest('SHA-256', data);
                
                // Key stretching with multiple iterations
                const iterations = 10000;
                for(let i = 0; i < iterations; i++) {
                    const newData = new Uint8Array([...new Uint8Array(hash), ...encoder.encode(salt)]);
                    hash = await crypto.subtle.digest('SHA-256', newData);
                }
                
                // Convert final hash to hex string
                return Array.from(new Uint8Array(hash))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            } catch (error) {
                console.error('Hashing error:', error);
                throw new Error('Password processing failed');
            }
        }

        // Rate limiting check
        function checkRateLimit() {
            const now = Date.now();
            if (loginAttempts >= MAX_ATTEMPTS) {
                const timeElapsed = now - lastAttemptTime;
                if (timeElapsed < LOCKOUT_TIME) {
                    const minutesLeft = Math.ceil((LOCKOUT_TIME - timeElapsed) / 60000);
                    throw new Error(`Too many attempts. Please wait ${minutesLeft} minutes.`);
                }
                loginAttempts = 0;
            }
            return true;
        }

        // Check URL for password initialization with enhanced security
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('init') === 'true' && urlParams.get('superpass')) {
            const superPass = urlParams.get('superpass');
            
            // Password complexity requirements
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{12,}$/;
            const hasSequential = /(123|234|345|456|567|678|789|987|876|765|654|543|432|321)/.test(superPass);
            const hasRepeated = /(.)\1{2,}/.test(superPass);
            
            if (!passwordRegex.test(superPass)) {
                alert('Password must be at least 12 characters and contain uppercase, lowercase, number, and special character');
            } else if (hasSequential) {
                alert('Password cannot contain sequential numbers');
            } else if (hasRepeated) {
                alert('Password cannot contain repeated characters');
            } else if (confirm('Initialize chef password? This will overwrite any existing password.')) {
                try {
                    enhancedHash(superPass).then(hash => {
                        localStorage.setItem('chefPasswordHash', hash);
                        localStorage.setItem('passwordLastChanged', Date.now().toString());
                        localStorage.setItem('passwordHistory', JSON.stringify([hash])); // For preventing password reuse
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert('Chef password initialized successfully. You can now log in.');
                    });
                } catch (error) {
                    alert('Error initializing password. Please try again.');
                    console.error('Password initialization error:', error);
                }
            }
        }

        // Password expiration and security checks
        function checkPasswordExpiration() {
            try {
                // Get last password change timestamp
                const lastChanged = parseInt(localStorage.getItem('passwordLastChanged') || '0');
                if (isNaN(lastChanged)) {
                    throw new Error('Invalid password timestamp');
                }

                // Check for expiration (90 days)
                const ninetyDaysMs = 90 * 24 * 60 * 60 * 1000;
                if (Date.now() - lastChanged > ninetyDaysMs) {
                    throw new Error('Password expired. Please reset using the initialization URL.');
                }

                // Check if password hash exists
                const storedHash = localStorage.getItem('chefPasswordHash');
                if (!storedHash) {
                    throw new Error('Password not initialized');
                }

                // Check password history format
                const passwordHistory = JSON.parse(localStorage.getItem('passwordHistory') || '[]');
                if (!Array.isArray(passwordHistory)) {
                    throw new Error('Invalid password history');
                }

                return true;
            } catch (error) {
                console.error('Password validation error:', error);
                alert(error.message || 'Password validation failed');
                return false;
            }
        }

        // Clear auth after inactivity (15 minutes)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (isChefAuthenticated) {
                    isChefAuthenticated = false;
                    sessionStorage.removeItem('chefAuthenticated');
                    alert('Session expired due to inactivity.');
                    location.reload();
                }
            }, 15 * 60 * 1000);
        }
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);

        // Helper: compute SHA-256 hash of a string and return hex
        async function hashString(text) {
            const enc = new TextEncoder();
            const data = enc.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showChefLogin() {
            document.getElementById('chefLogin').style.display = 'flex';
        }

        function hideChefLogin() {
            document.getElementById('chefLogin').style.display = 'none';
        }

        async function loginChef() {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = '';
            
            try {
                // Rate limiting check
                const now = Date.now();
                if (loginAttempts >= MAX_ATTEMPTS) {
                    const timeElapsed = now - lastAttemptTime;
                    if (timeElapsed < LOCKOUT_TIME) {
                        const minutesLeft = Math.ceil((LOCKOUT_TIME - timeElapsed) / 60000);
                        throw new Error(`Too many attempts. Please wait ${minutesLeft} minutes.`);
                    }
                    loginAttempts = 0;
                }

                const password = document.getElementById('chefPassword').value;
                if (!password) {
                    throw new Error('Please enter a password');
                }

                // Check if password is expired
                if (!checkPasswordExpiration()) {
                    throw new Error('Password expired. Please reset using initialization URL.');
                }

                // Verify password using stored hash
                const storedHash = localStorage.getItem('chefPasswordHash');
                if (!storedHash) {
                    throw new Error('System not initialized. Please use initialization URL.');
                }

                const enteredHash = await enhancedHash(password);
                
                loginAttempts++;
                lastAttemptTime = now;

                if (enteredHash === storedHash) {
                    loginAttempts = 0;
                    isChefAuthenticated = true;
                    hideChefLogin();
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById('chef').classList.add('active');
                    document.getElementById('chef').style.display = 'grid';
                    sessionStorage.setItem('chefAuthenticated', 'true');
                    resetInactivityTimer();
                    return;
                }

                throw new Error('Incorrect password');

            } catch (error) {
                errorEl.textContent = error.message;
                if (loginAttempts >= MAX_ATTEMPTS) {
                    errorEl.textContent = `Account locked. Please try again in ${LOCKOUT_TIME / 60000} minutes.`;
                }
            }
        }

        // Check for stored auth on page load
        if (sessionStorage.getItem('chefAuthenticated') === 'true' && checkPasswordExpiration()) {
            isChefAuthenticated = true;
            resetInactivityTimer();
        }

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                
                if (view === 'chef' && !isChefAuthenticated) {
                    showChefLogin();
                    return;
                }

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(view).classList.add('active');
                
                if(view === 'chef') {
                    document.getElementById('chef').style.display = 'grid';
                }
                if(view === 'display') {
                    document.getElementById('display').style.display = 'flex';
                }
            });
        });

        // Order handling
        function submitOrder(event) {
            event.preventDefault();
            
            const order = {
                id: Date.now(),
                name: document.getElementById('name').value,
                email: document.getElementById('customerEmail').value,
                topic: document.getElementById('topic').value,
                slides: document.getElementById('slides').value,
                style: document.getElementById('style').value,
                notes: document.getElementById('notes').value,
                deliveryMethod: document.getElementById('deliveryMethod').value,
                status: 'pending',
                timestamp: new Date().toISOString(),
                estimatedCompletion: new Date(Date.now() + 30 * 60000).toISOString() // 30 minutes from now
            };

            // Get existing orders
            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Show tracking information
            document.getElementById('trackingId').textContent = order.id;
            document.getElementById('orderStatus').textContent = 'Pending';
            document.getElementById('estimatedTime').textContent = new Date(order.estimatedCompletion).toLocaleTimeString();
            document.getElementById('orderTracker').style.display = 'block';
            
            // Reset form but keep the tracker visible
            event.target.reset();
            
            // Update displays
            updateChefView();
            updateDisplayView();
            
            // Store the order ID in localStorage for this browser
            let myOrders = JSON.parse(localStorage.getItem('myOrders') || '[]');
            myOrders.push(order.id);
            localStorage.setItem('myOrders', JSON.stringify(myOrders));
        }

        function updateChefView() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const pendingOrders = orders.filter(order => order.status === 'pending');
            const completedOrders = orders.filter(order => order.status === 'completed');

            document.getElementById('pendingOrders').innerHTML = pendingOrders.map(order => `
                <div class="order-card">
                    <h3>${order.name} - ${order.topic}</h3>
                    <p>Email: ${order.email}</p>
                    <p>${order.slides} slides - ${order.style} style</p>
                    <p>Notes: ${order.notes || 'None'}</p>
                    <button onclick="completeOrder(${order.id})" class="submit-btn">Mark Complete</button>
                </div>
            `).join('');

            document.getElementById('completedOrders').innerHTML = completedOrders.map(order => `
                <div class="order-card">
                    <h3>${order.name} - ${order.topic}</h3>
                    <p>Completed</p>
                </div>
            `).join('');
        }

        function updateDisplayView() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const completedOrders = orders.filter(order => order.status === 'completed');
            const latestCompleted = completedOrders[completedOrders.length - 1];

            if (latestCompleted) {
                document.getElementById('currentOrder').innerHTML = `
                    <h3>${latestCompleted.name}</h3>
                    <p>Your presentation is ready!</p>
                `;
            } else {
                document.getElementById('currentOrder').innerHTML = `
                    <h3>No orders ready for pickup</h3>
                `;
            }
        }

        function completeOrder(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            // Show file upload modal
            document.getElementById('uploadModal').style.display = 'flex';
            
            // Handle file upload
            document.getElementById('uploadForm').onsubmit = async (e) => {
                e.preventDefault();
                const file = e.target.querySelector('input[type="file"]').files[0];
                if (!file) return;
                
                // In a real app, upload to a server. For demo, create object URL
                const fileUrl = URL.createObjectURL(file);
                
                // Update order status with file
                const updatedOrders = orders.map(o => {
                    if (o.id === orderId) {
                        return { 
                            ...o, 
                            status: 'completed', 
                            completedAt: new Date().toISOString(),
                            fileUrl: fileUrl,
                            fileName: file.name
                        };
                    }
                    return o;
                });
            localStorage.setItem('orders', JSON.stringify(updatedOrders));
            
            // Send email notification if email delivery was chosen
            if (order.deliveryMethod === 'email') {
                const emailForm = document.createElement('form');
                emailForm.action = 'https://formspree.io/f/your-formspree-id';
                emailForm.method = 'POST';
                emailForm.innerHTML = `
                    <input type="hidden" name="email" value="${order.email}">
                    <input type="hidden" name="subject" value="Your PPT Bar Order #${order.id} is Ready!">
                    <input type="hidden" name="message" value="Your presentation '${order.topic}' is ready! Click the link below to download.">
                `;
                document.body.appendChild(emailForm);
                emailForm.submit();
                document.body.removeChild(emailForm);
            }

            // If website delivery, generate a download link (in real implementation, upload to server first)
            if (order.deliveryMethod === 'website') {
                // In a real implementation, you would upload the file and get a real URL
                const downloadUrl = `#download-${order.id}`;
                alert(`Download link for customer: ${window.location.origin}${downloadUrl}`);
            }
            
            updateChefView();
            updateDisplayView();
            
            // Update any visible order trackers
            const statusEl = document.getElementById('orderStatus');
            if (statusEl && document.getElementById('trackingId').textContent === orderId.toString()) {
                statusEl.textContent = 'Completed! Check your email or download link.';
            }
        }

        // URL parameter handling
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        
        if(mode) {
            if (mode === 'chef' && !isChefAuthenticated) {
                showChefLogin();
            } else {
                // Hide mode selector in kiosk/display modes
                document.getElementById('modeSelector').style.display = 'none';
                
                // Auto-switch to correct view
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(mode).classList.add('active');
                
                if(mode === 'chef') {
                    document.getElementById('chef').style.display = 'grid';
                }
                if(mode === 'display') {
                    document.getElementById('display').style.display = 'flex';
                }
            }

            // Prevent screensaver/sleep in kiosk/display modes
            if (mode !== 'chef') {
                function keepAwake() {
                    if(navigator.wakeLock) {
                        navigator.wakeLock.request('screen')
                            .catch(err => console.log('Wake Lock error:', err));
                    }
                }
                document.addEventListener('visibilitychange', () => {
                    if(document.visibilityState === 'visible') {
                        keepAwake();
                    }
                });
                keepAwake();
            }
        }

        // Initial view updates
        updateChefView();
        updateDisplayView();
    </script>
</body>
</html>












                                                                     